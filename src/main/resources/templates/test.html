<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet"  th:href="@{css/page.css}">
    <script src="http://cdn.staticfile.org/jquery/3.6.0/jquery.js"></script>
    <script th:inline="javascript">
        $(function(){
            var pageSize = 5;
            var lastPage;
            var pageNum = 1;
            var buildingId;
            var roomId;

            viewAllWaterOrder(1, pageSize);
            var curView = "viewAllWaterOrder";
            addPage(1, lastPage);
            addEvent(lastPage);

            $("#search").click(function(){
                buildingId = $("#building").val()
                var floor = $("#floor").val();
                var room = $("#room").val();
                roomId = floor + room;
                if(buildingId != "null"){
                    if(floor != "null" && room != "null"){
                        pageNum = 1;
                        viewRoomWaterOrder(buildingId, roomId, pageNum, pageSize);
                        curView = "viewRoomWaterOrder"
                        addPage(1, lastPage);
                        addEvent(lastPage);

                    }else if(floor == "null" && room == "null"){
                        pageNum = 1;
                        viewBuildingWaterOrder(buildingId, pageNum, pageSize);
                        curView = "viewBuildingWaterOrder";
                        addPage(1, lastPage);
                        addEvent(lastPage);

                    }else {
                        alert("请确认查找信息")
                    }
                }else {
                    alert("请确认查找信息")
                }
            })

            $("#viewAll").click(function(){
                viewAllWaterOrder(1, pageSize);
                curView = "viewAllWaterOrder";
                addPage(1, lastPage);
                addEvent(lastPage);
                $(".firstOption").prop("selected",true)
            })

            function viewAllWaterOrder(pageNum, pageSize){
                $("#table>tbody").html("");  // 清空表格
                $.ajax({
                    url:"getAllWaterOrder?pageNum=" + pageNum + "&pageSize=" + pageSize,
                    async: false,
                    method: 'post',
                    success:function(data) {
                        view(data);
                        lastPage = data.navigateLastPage;
                    }
                })
            }

            function viewBuildingWaterOrder(buildingId, pageNum, pageSize){
                $("#table>tbody").html("");  // 清空表格
                $.ajax({
                    url:"getBuildingWaterOrder?buildingId=" + buildingId + "&pageNum=" + pageNum + "&pageSize=" + pageSize,
                    async: false,
                    method: 'post',
                    success:function(data) {
                        view(data);
                        lastPage = data.navigateLastPage;
                    }
                })
            }

            function viewRoomWaterOrder(buildingId, roomId, pageNum, pageSize){
                $("#table>tbody").html("");  // 清空表格
                $.ajax({
                    url:"getRoomWaterOrder?buildingId=" + buildingId + "&roomId=" + roomId + "&pageNum=" + pageNum + "&pageSize=" + pageSize,
                    async: false,
                    method: 'post',
                    success:function(data) {
                        view(data);
                        lastPage = data.navigateLastPage;
                    }
                })
            }

            function addPage(current,maxPage){
                //清空容器
                $(".lq-page").html('');
                //1.显示 [首页] [上一页]
                if(current>1){
                    $(".lq-page").append('<span class="page-start">首页</span><span class="page-before">上一页</span>');
                }else{
                    $(".lq-page").append('<span class="page-before disable">上一页</span>');
                }
                //2.首页 上一页 【...】
                if(current>3 && maxPage>5){
                    $(".lq-page").append('<span class="page-ell">...</span>');
                }

                //3.显示页码  首页 上一页 ...  2 3 【4】 5 6 ...
                var start=current-2
                var end=current+2;
                //特殊的位置：开头位置 current=1 / 2
                if(current <= 2 ){
                    start=1;
                    end=maxPage>5?5:maxPage;
                }
                if(current >= maxPage-1){
                    start=maxPage-4>0?maxPage-4:1;
                    end=maxPage;
                }
                for(;start<=end;start++){
                    if(start==current){
                        $(".lq-page").append('<span class="page on">'+start+'</span>');
                    }else{
                        $(".lq-page").append('<span class="page">'+start+'</span>');
                    }
                }

                //4. 显示 首页 上一页 ...  2 3 4 5 6 [...] 控制
                if(maxPage>5 && current < maxPage-2){
                    $(".lq-page").append('<span class="page-ell">...</span>');
                }

                //5.下一页 和 尾页
                if(current<maxPage){
                    $(".lq-page").append('<span class="page-after">下一页</span><span class="page-end">尾页</span>');
                }else{
                    $(".lq-page").append('<span class="page-after disable">下一页</span>');
                }
            }

            //二、点击事件 ---动态创建的元素---必须通过绑定添加事件
            function addEvent(maxPage){
                $(".lq-page").off('click');
                $(".lq-page").on('click','.page',function(){
                    console.log($(this).html());//string
                    var num=parseInt($(this).html());
                    getData(num);
                    checkCurentView(curView);
                })

                //2.点击首页
                $(".lq-page").on('click','.page-start',function(){
                    getData(1);
                    pageNum = num;
                    checkCurentView(curView);
                })
                //3.点击尾页
                $(".lq-page").on('click','.page-end',function(){
                    getData(maxPage)
                    pageNum = num;
                    checkCurentView(curView);
                })

                //4.点击下一页
                $(".lq-page").on('click','.page-after',function(){
                    var num=parseInt($(this).siblings('.on').html());
                    num++;
                    console.log(num);
                    pageNum = num;
                    // viewAllWaterOrder(num, pageSize);
                    checkCurentView(curView);
                    if(num<=maxPage){
                        getData(num)
                    }
                })
                //5.点击上一页
                $(".lq-page").on('click','.page-before',function(){
                    var num=parseInt($(this).siblings('.on').html());
                    num--;
                    console.log(num);
                    pageNum = num;
                    // viewAllWaterOrder(num, pageSize);
                    checkCurentView(curView);
                    if(num >= 1){
                        getData(num)
                    }
                })
            }


            function getData(num){
                addPage(num,lastPage);
                addEvent(lastPage);
            }

            function checkCurentView(curView){
                if(curView == "viewAllWaterOrder"){
                    viewAllWaterOrder(pageNum, pageSize);
                    addPage(1, lastPage);
                    addEvent(lastPage);
                }else if(curView == "viewBuildingWaterOrder"){
                    viewBuildingWaterOrder(buildingId, pageNum, pageSize);
                    addPage(1, lastPage);
                    addEvent(lastPage);
                }else if(curView == "viewRoomWaterOrder"){
                    viewRoomWaterOrder(buildingId, roomId, pageNum, pageSize);
                    addPage(1, lastPage);
                    addEvent(lastPage);
                }
            }

        })



        function view(data){
            $.each(data.list, function(index, waterOrder) {
                var tr = $("<tr>"
                    + "<td>" + waterOrder.buildingId + "</td>"
                    + "<td>" + waterOrder.roomId + "</td>"
                    + "<td>" + waterOrder.username + "</td>"
                    + "<td> " + waterOrder.number + "</td>"
                    + "<td>" + waterOrder.amount + "</td>"
                    + "<td>" + waterOrder.orderTime + "</td>"
                    + "</tr>");
                $("#table>tbody").append(tr);
            })
        }
    </script>
</head>
    <body id="body">
    <form id="form2">
        <select id="building" >
            <option class="firstOption" selected="selected" value="null">==楼栋==</option>
            <option value="25">#25</option>
            <option value="26">#26</option>
            <option value="27">#27</option>
            <option value="28">#28</option>
            <option value="29">#29</option>
        </select>
        <select id="floor" >
            <option class="firstOption" selected="selected" value="null">==楼层==</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="5">6</option>
        </select>
        <select id="room" >
            <option class="firstOption" selected="selected" value="null">==房间==</option>
            <option value="01">01</option>
            <option value="02">02</option>
            <option value="03">03</option>
            <option value="04">04</option>
            <option value="05">05</option>
            <option value="06">06</option>
            <option value="07">07</option>
            <option value="08">08</option>
            <option value="09">09</option>
            <option value="10">10</option>
        </select>
        <input type="button" id="search" value="查询"><br>
        <input type="button" id="viewAll" value="查看所有"><br>

        <form id="form">
            <table id="table">
                <thead>
                <tr>
                    <th>楼栋</th>
                    <th>宿舍号</th>
                    <th>姓名</th>
                    <th>数量</th>
                    <th>金额</th>
                    <th>时间</th>
                </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
            <div class="lq-page"></div>
        </form>
    </body>
</html>